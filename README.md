# PHILPHANGS: Filament Identification Pipeline

Associated Paper: Coming Soon!

### Setup

FilPHANGS is an extensive pipeleine that relies on the filament identification algorithm SOAX. The first step is to download the SOAX batch file, found here: https://www.lehigh.edu/~div206/soax/downloads.html. 
It is currently available for Windows and Mac OS High Sierrra, but is actively being adapted to run on newer mac OS. After SOAX is installed, Julia will also need to be installed in order to use the cloud clean source removal: https://github.com/andrew-saydjari/CloudClean.jl. You do not need to install this repository, only Julia. Julia can be downloaded from this page: https://julialang.org/downloads/. 

After SOAX and Julia are downloaded, clone the repository and set up a FilPHANGS virtual environment using Conda. In this virtual environment, type 
``` pip install -r requirements.txt ``` in terminal to automatically install the required libraries. 

The next step is to set up the FilPHANGS directory, where all output products will be stored. The entire Pipeline requires a very specific directory structure, described below: 

```
FilPHANGS_base_directory/
├── OriginalImages/
├── CSV_Data.csv          # does not need to be in this directory, but recommended to keep all FilPHANGS files together
├── Soax_Parameters.txt   # does not need to be in this directory, but recommended to keep all FilPHANGS files together
└── Figures/
```

OriginalImages contains all of the original images that you wish to process with FilPHANGS. It is required that the image names contain the image label (i.e. ngc0628) and the image band (i.e. F770W) seperated by an underscore. Other descriptors can also be in the name, but will be overwritten later on. The CSV_Data contains information on each galaxy that will be processed, and is referenced repeatedly by the software during run time. Soax_Parameters.txt contains the SOAX parameters we determined to be best. 

Now we are ready to run FilPHANGS. Open Main.py and update the file paths at the top of the file to point to the correct locations. After this is done, FilPHANSG is ready to go! There are two functions which are immediately called, mainFuncs.renameFitsFiles() and mainFuncs.createDirectoryStructure(). These two functions will standardize all image names in the OriginalImages folder and will fill out the directory structure. Specifically, each image in OriginalImages will get its own output sub-directory, detailed below for an example image: 

```
FilPHANGS_base_directory/
├── OriginalImages/
├── CSV_Data.csv
├── Soax_Parameters.txt   # (does not need to be in this directory, but recommended to keep all FilPHANGS files together)
└── Figures/
└── ngc0628_F770W/
  └── BkgSubDivRMS/    # Containes background subtracted and scale decomposed Fits Files for trouble shooting
  └── BlockedPng/      # Containes background subtracted and scale decomposed png files passed into SOAX
  └── CDD/             # Containes parcec level decomposition into desired scales (namely 8pc, 16pc, 32pc, 64pc, 128pc, and 256pc)
  └── Composites/      # Contains composite filament maps containing information from all 10 SOAX runs for each scale
  └── SoaxOutput       # Contains SOAX outputs, with subfolders for each scale. SOAX output is a text file, so this also contains the reconstructed Fits File of the filament network. 
  └── SourceRemoval/   # Contains pixel level decomposition used for source detection as well as source removed output images. 
  └── SyntheticMap/    #Contains CSV files with filament properties extracted and synthetic images of the filament network based on Point Spread Function Fits
```

### Using FilPHANGS

Ensure that all columns are filled out in the CSV file and we can run Main.py. The only two limitations to be immediately aware of is that source removal will only work with F200W, F300W,F335M, F336M. F770W,F1000W, F1130W, F2100W at present. Further, the synthetic map generation and filament property extraction are only reliable with these bands. However, filament networks can be identified for attenuation images such as in the F550W band and many non-JWST images. 

A typical galaxy will take anywhere between 1-3 hours to complete the pipeline (including synthetic map generation and property extraction) and will require ~3GB of storage. Plotting functions are also supported in the DataProcessing folder, which will access the CSV files with all of the saved filament property data and plot by scale and galaxy. 

### Additional Features

Certain Users may be interested in Filament comparison between galaxy regions (such as center vs interarm). This feature is supported if the path to a folder containing region masks is provided. Currently, this is only supported for region masks generated by the PHANGS team. Further, property extraction can be improved from the default to use dynamic AlphaCO maps instead of the constant of 5.5 described in https://iopscience.iop.org/article/10.3847/1538-4357/adbd40. This feature is only available for JWST images if a path to an alphaCO folder is provided in Main.py. 

### Note
All curvature calculations come directly from FilFinder: https://github.com/e-koch/FilFinder


